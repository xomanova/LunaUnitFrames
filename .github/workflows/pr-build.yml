name: PR Build

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  build:
    name: Build Addon
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get addon info
        id: addon_info
        run: |
          # Extract addon name from TOC file
          ADDON_NAME=$(basename *.toc .toc)
          echo "addon_name=${ADDON_NAME}" >> $GITHUB_OUTPUT
          
          # Extract version from TOC file
          VERSION=$(grep -i "^## Version:" *.toc | sed 's/## Version: *//' | tr -d '\r')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # Extract interface version
          INTERFACE=$(grep -E "^## Interface:" *.toc | sed 's/## Interface: *//' | tr -d '\r')
          echo "interface=${INTERFACE}" >> $GITHUB_OUTPUT
          
          # Get short SHA for artifact naming
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          
          # Get branch name (sanitized for filenames)
          BRANCH_NAME="${{ github.head_ref }}"
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "branch=${SAFE_BRANCH}" >> $GITHUB_OUTPUT

      - name: Build and Package Addon
        uses: BigWigsMods/packager@v2
        with:
          args: -d -z
        # -d = skip uploading to distribution sites
        # -z = skip creating zip (we'll do it ourselves with custom naming)

      - name: Create release package
        id: package
        run: |
          ADDON_NAME="${{ steps.addon_info.outputs.addon_name }}"
          BRANCH="${{ steps.addon_info.outputs.branch }}"
          SHORT_SHA="${{ steps.addon_info.outputs.short_sha }}"
          PACKAGE_NAME="${ADDON_NAME}-${BRANCH}-${SHORT_SHA}"
          
          # The packager creates .release/LunaUnitFrames
          if [ -d ".release/${ADDON_NAME}" ]; then
            cd .release
            zip -r "../${PACKAGE_NAME}.zip" "${ADDON_NAME}"
            cd ..
            echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
            echo "package_file=${PACKAGE_NAME}.zip" >> $GITHUB_OUTPUT
            echo "âœ… Package created: ${PACKAGE_NAME}.zip"
            ls -la "${PACKAGE_NAME}.zip"
          else
            echo "âŒ Package directory not found"
            ls -la .release/ || echo "No .release directory"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.package_name }}
          path: ${{ steps.package.outputs.package_file }}
          retention-days: 14
          if-no-files-found: error

      - name: Add PR comment with download info
        uses: actions/github-script@v7
        with:
          script: |
            const addonName = '${{ steps.addon_info.outputs.addon_name }}';
            const branch = '${{ steps.addon_info.outputs.branch }}';
            const shortSha = '${{ steps.addon_info.outputs.short_sha }}';
            const version = '${{ steps.addon_info.outputs.version }}';
            const iface = '${{ steps.addon_info.outputs.interface }}';
            const runId = context.runId;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const packageName = '${{ steps.package.outputs.package_name }}';
            
            const body = `## ðŸ“¦ Build Artifact Ready
            
            | Property | Value |
            |----------|-------|
            | **Addon** | ${addonName} |
            | **Version** | ${version} |
            | **Interface** | ${iface} |
            | **Branch** | \`${branch}\` |
            | **Commit** | \`${shortSha}\` |
            
            ### Download
            
            1. Go to the [workflow run](${runUrl})
            2. Scroll to **Artifacts** section
            3. Download \`${packageName}\`
            4. Extract to your \`Interface/AddOns\` folder
            
            *Artifact will be available for 14 days.*`;
            
            // Find existing bot comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“¦ Build Artifact Ready')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
